@startuml
!include plantuml_options.txt

title URI Resolution & Plugin Scoring

participant "Client" as client
participant "ConfiguredFileSources" as configured
participant "Plugin Registry" as registry
participant "S3FsFilesSource" as s3
participant "HTTPFilesSource" as http
participant "PosixFilesSource" as posix

client -> configured : get_file_source_path("s3://my-bucket/data.csv")
activate configured

configured -> configured : find_best_match(url)
activate configured

configured -> registry : iterate all plugins
activate registry

registry -> s3 : score_url_match(url)
activate s3
s3 --> registry : 15 (len "s3://my-bucket/")
deactivate s3

registry -> http : score_url_match(url)
activate http
http --> registry : 0 (no match)
deactivate http

registry -> posix : score_url_match(url)
activate posix
posix --> registry : 0 (no match)
deactivate posix

registry --> configured : best_match = S3FsFilesSource
deactivate registry

deactivate configured

configured --> client : (S3FsFilesSource, "data.csv")
deactivate configured

note right of s3
    Higher score = better match
    0 = not supported
    len(prefix) = exact match
end note

note right of configured
    Evaluates stock plugins
    + user-defined instances
end note

@enduml
